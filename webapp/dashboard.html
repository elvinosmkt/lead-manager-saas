<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Lead Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-950 text-white min-h-screen pb-20">

    <!-- Navbar Fixa -->
    <nav class="border-b border-gray-800 bg-gray-900/90 backdrop-blur sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div
                        class="w-9 h-9 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/50">
                        <i class="fas fa-rocket text-white text-sm"></i>
                    </div>
                    <div>
                        <span class="font-bold text-lg tracking-tight">LeadManager</span>
                        <span class="text-[10px] uppercase font-bold text-gray-400 block -mt-1 tracking-widest">CRM &
                            Scraper</span>
                    </div>
                </div>

                <!-- Status Bar -->
                <div class="flex items-center gap-6">
                    <!-- Configurar Mensagem -->
                    <button onclick="openScriptModal()"
                        class="hidden md:flex items-center gap-2 text-sm text-gray-300 hover:text-white bg-gray-800/50 hover:bg-gray-800 px-3 py-1.5 rounded-full border border-gray-700 transition">
                        <i class="fas fa-comment-dots text-green-400"></i>
                        <span>Script de Venda</span>
                    </button>

                    <!-- Saldo de Créditos com Barra -->
                    <div id="creditsBox"
                        class="bg-gray-800 rounded-2xl px-4 py-2 border border-gray-700 flex flex-col gap-1 min-w-[180px]">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div id="creditsDot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                <span class="text-xs text-gray-400 uppercase font-bold">Créditos</span>
                            </div>
                            <span id="creditsDisplay" class="font-mono font-bold text-green-400">---</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                            <div id="creditsBar" class="bg-green-500 h-1.5 rounded-full transition-all duration-500"
                                style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- User -->
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block">
                            <h4 id="userName" class="text-sm font-bold leading-none">Admin</h4>
                            <span class="text-xs text-blue-400">Plano Pro</span>
                        </div>
                        <div class="w-9 h-9 rounded-full bg-gradient-to-r from-gray-700 to-gray-600 border-2 border-gray-800 shadow-xl overflow-hidden cursor-pointer"
                            onclick="logout()">
                            <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="User">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 mt-8">

        <!-- Área de Busca (Compacta) -->
        <div
            class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-2xl p-1 shadow-2xl border border-gray-800 mb-10 overflow-hidden relative group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <i class="fas fa-search text-6xl"></i>
            </div>

            <div class="bg-gray-900/90 p-6 rounded-xl backdrop-blur-sm">
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Nicho</label>
                        <div class="relative">
                            <i class="fas fa-tag absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="text" id="nichoInput" placeholder="Ex: Pizzaria, Dentista..."
                                class="w-full bg-gray-950 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition shadow-inner">
                        </div>
                    </div>

                    <div class="flex-1 w-full space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Cidade</label>
                        <div class="relative">
                            <i class="fas fa-location-dot absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="text" id="cidadeInput" placeholder="Ex: Centro, São Paulo..."
                                class="w-full bg-gray-950 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition shadow-inner">
                        </div>
                    </div>

                    <div class="w-32 space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Qtd</label>
                        <select id="maxLeadsInput"
                            class="w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-3 text-white outline-none">
                            <option value="10">10 Leads</option>
                            <option value="50">50 Leads</option>
                            <option value="100">100 Leads</option>
                        </select>
                    </div>

                    <button id="btnSearch" onclick="startSearch()"
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-900/30 transition transform active:scale-95 flex items-center justify-center gap-2 border border-blue-500/50">
                        <i class="fas fa-search"></i>
                        <span>BUSCAR</span>
                    </button>

                    <button id="btnStop" onclick="stopSearch()"
                        class="hidden w-full md:w-auto bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-red-900/30 transition transform active:scale-95 flex items-center justify-center gap-2 border border-red-500/50">
                        <i class="fas fa-stop"></i>
                        <span>PARAR</span>
                    </button>
                </div>

                <!-- Barra de Progresso Integrada -->
                <div id="progressContainer"
                    class="hidden mt-6 bg-gray-800 rounded-lg p-3 flex items-center gap-4 border border-gray-700">
                    <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin text-blue-400"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-blue-300 font-bold" id="currentBusiness">Iniciando motor de
                                busca...</span>
                            <span class="text-gray-400 font-mono"><span id="leadsFoundCount">0</span> leads</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                            <div id="progressBar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros de Funil e Busca Avançada -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <!-- Filtros de Status (Abas) -->
            <div class="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide flex-1">
                <button onclick="filterLeads('all')"
                    class="filter-btn active bg-white text-gray-900 px-4 py-3 rounded-full text-sm font-bold shadow-lg transition"
                    data-status="all">
                    Todos <span id="countAll"
                        class="bg-gray-200 text-gray-800 px-1.5 py-0.5 rounded-full text-[10px] ml-1">0</span>
                </button>
                <button onclick="filterLeads('contacted')"
                    class="filter-btn bg-gray-800 border border-gray-700 text-green-400 px-4 py-3 rounded-full text-sm font-medium hover:bg-gray-700 transition"
                    data-status="contacted">
                    Contactados
                </button>
            </div>

            <!-- Filtros de Texto (Cidade/Area) -->
            <div class="flex gap-2">
                <div class="relative flex-1 md:flex-none">
                    <i class="fas fa-filter absolute left-3 top-3 text-gray-500 text-xs"></i>
                    <input type="text" id="filterCity" onkeyup="applyFilters()" placeholder="Filtrar Cidade/Bairro"
                        class="bg-gray-900 border border-gray-700 rounded-xl pl-8 pr-3 py-2.5 text-sm text-white focus:border-blue-500 outline-none w-full md:w-48 transition shadow-inner">
                </div>
                <div class="relative flex-1 md:flex-none">
                    <i class="fas fa-briefcase absolute left-3 top-3 text-gray-500 text-xs"></i>
                    <input type="text" id="filterNiche" onkeyup="applyFilters()" placeholder="Filtrar Nicho"
                        class="bg-gray-900 border border-gray-700 rounded-xl pl-8 pr-3 py-2.5 text-sm text-white focus:border-blue-500 outline-none w-full md:w-44 transition shadow-inner">
                </div>
            </div>

            <button onclick="exportToExcel()"
                class="bg-gray-800 hover:bg-gray-700 text-gray-100 border border-gray-600 rounded-xl px-4 py-2 text-sm font-medium transition flex items-center gap-2">
                <i class="fas fa-download"></i> Exportar
            </button>
        </div>

        <!-- Grid de Cards (CRM) -->
        <div id="leadsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Empty State -->
            <div id="emptyState"
                class="col-span-full py-20 text-center border-2 border-dashed border-gray-800 rounded-3xl bg-gray-900/30">
                <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-ghost text-3xl text-gray-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-300">Nenhum lead por aqui</h3>
                <p class="text-gray-500 mt-2 max-w-sm mx-auto">Faça uma busca acima para encontrar empresas sem site e
                    começar a vender.</p>
            </div>
        </div>

    </main>

    <!-- Modal: Script de Venda -->
    <div id="scriptModal"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div
            class="bg-gray-900 border border-gray-800 rounded-2xl w-full max-w-lg shadow-2xl transform transition-all p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fab fa-whatsapp text-green-500"></i> Configurar Abordagem
                </h3>
                <button onclick="closeScriptModal()" class="text-gray-500 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="space-y-4">
                <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-lg text-sm text-blue-200">
                    <p class="font-bold mb-1"><i class="fas fa-info-circle"></i> Variáveis:</p>
                    <code class="bg-black/30 px-1 rounded text-blue-300">{nome}</code>, <code
                        class="bg-black/30 px-1 rounded text-blue-300">{nicho}</code>, <code
                        class="bg-black/30 px-1 rounded text-blue-300">{cidade}</code>
                </div>

                <textarea id="msgTemplate" rows="6"
                    class="w-full bg-gray-950 border border-gray-700 rounded-xl p-4 text-gray-300 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none resize-none"
                    placeholder="Olá, vi a {nome} no Google..."></textarea>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="resetScript()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">Padrão</button>
                <button onclick="saveScript()"
                    class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-green-900/30 transition">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        let leads = [];
        let isSearching = false;
        let pollingInterval = null;
        let currentStatusFilter = 'all';
        let msgTemplate = localStorage.getItem('leadManager_msg') ||
            "Olá! Encontrei a *{nome}* no Google Maps aqui de {cidade} e vi que a empresa ainda não tem um Site Profissional.\n\nSou especialista em criar sites para {nicho} que atraem mais clientes. Gostaria de ver uma proposta?";

        document.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            loadLeadsFromDB();
            document.getElementById('msgTemplate').value = msgTemplate;
        });

        async function loadUserInfo() {
            try {
                // Se LeadAPI estiver disponível (carregado via supabase-client.js)
                if (window.LeadAPI) {
                    const user = await LeadAPI.getUser();
                    const credits = await LeadAPI.checkCredits();

                    if (user) {
                        const name = user.email.split('@')[0];
                        document.getElementById('userName').innerText = name;
                    }

                    if (credits) {
                        const used = credits.credits_used || 0;
                        const limit = credits.credits_limit || 500;
                        const remaining = limit - used;
                        const percent = Math.max(0, Math.min(100, (remaining / limit) * 100));

                        document.getElementById('creditsDisplay').innerText = `${remaining}/${limit}`;
                        document.getElementById('creditsBar').style.width = `${percent}%`;

                        // Cores baseadas na porcentagem
                        const bar = document.getElementById('creditsBar');
                        const dot = document.getElementById('creditsDot');
                        const display = document.getElementById('creditsDisplay');

                        if (percent < 10) {
                            bar.className = 'bg-red-500 h-1.5 rounded-full transition-all duration-500';
                            dot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                            display.className = 'font-mono font-bold text-red-400';
                        } else if (percent < 30) {
                            bar.className = 'bg-yellow-500 h-1.5 rounded-full transition-all duration-500';
                            dot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                            display.className = 'font-mono font-bold text-yellow-400';
                        } else {
                            bar.className = 'bg-green-500 h-1.5 rounded-full transition-all duration-500';
                            dot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
                            display.className = 'font-mono font-bold text-green-400';
                        }

                        // Alerta se créditos muito baixos
                        if (remaining < 20 && remaining > 0) {
                            showCreditAlert(remaining);
                        } else if (remaining <= 0) {
                            showNoCreditsAlert();
                        }
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar info do usuário:', e);
            }
        }

        function showCreditAlert(remaining) {
            const existingAlert = document.getElementById('creditAlert');
            if (existingAlert) return;

            const alert = document.createElement('div');
            alert.id = 'creditAlert';
            alert.className = 'fixed top-20 right-4 bg-yellow-500/90 text-black px-4 py-3 rounded-xl shadow-lg z-50 flex items-center gap-3 animate-pulse';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle text-xl"></i>
                <div>
                    <p class="font-bold">Créditos baixos!</p>
                    <p class="text-sm">Restam apenas ${remaining} créditos.</p>
                </div>
                <button onclick="this.parentElement.remove()" class="ml-2 text-black/50 hover:text-black">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(alert);
        }

        function showNoCreditsAlert() {
            const existingAlert = document.getElementById('noCreditsAlert');
            if (existingAlert) return;

            const alert = document.createElement('div');
            alert.id = 'noCreditsAlert';
            alert.className = 'fixed top-20 right-4 bg-red-600 text-white px-4 py-3 rounded-xl shadow-lg z-50 flex items-center gap-3';
            alert.innerHTML = `
                <i class="fas fa-times-circle text-xl"></i>
                <div>
                    <p class="font-bold">Créditos esgotados!</p>
                    <p class="text-sm">Faça upgrade para continuar.</p>
                </div>
                <a href="checkout.html" class="ml-2 bg-white text-red-600 px-3 py-1 rounded-lg font-bold text-sm hover:bg-gray-100">
                    UPGRADE
                </a>
            `;
            document.body.appendChild(alert);
        }

        async function loadLeadsFromDB() {
            try {
                if (window.LeadAPI) {
                    leads = await LeadAPI.getAll();
                    renderLeads();
                }
            } catch (e) {
                console.error('Erro ao carregar leads:', e);
            }
        }


        async function startSearch() {
            const nicho = document.getElementById('nichoInput').value;
            const cidade = document.getElementById('cidadeInput').value;
            if (!nicho || !cidade) return alert('Preencha os campos!');

            // Verifica usuário logado
            const user = await LeadAPI?.getUser();
            if (!user) {
                alert('Você precisa estar logado para fazer buscas.');
                window.location.href = 'login.html';
                return;
            }

            toggleSearchUI(true);
            leads = [];
            renderLeads();

            const res = await fetch('/api/start-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nicho,
                    cidade,
                    max_leads: document.getElementById('maxLeadsInput').value,
                    user_id: user.id
                })
            });

            if (res.ok) {
                startPolling();
            } else {
                const error = await res.json();
                if (error.code === 'no_credits') {
                    showNoCreditsAlert();
                } else {
                    alert(error.error || 'Erro ao iniciar busca');
                }
                toggleSearchUI(false);
            }
        }

        function toggleSearchUI(searching) {
            isSearching = searching;
            document.getElementById('btnSearch').classList.toggle('hidden', searching);
            document.getElementById('btnStop').classList.toggle('hidden', !searching);
            document.getElementById('progressContainer').classList.toggle('hidden', !searching);
        }

        function startPolling() {
            pollingInterval = setInterval(async () => {
                const res = await fetch('/api/search-status');
                const data = await res.json();
                updateProgress(data);
                if (data.leads && data.leads.length > leads.length) {
                    leads = data.leads.map(l => ({ ...l, status: l.status || 'new' }));
                    renderLeads();
                }
                if (!data.running && data.completed) stopSearch();
            }, 1000);
        }

        function stopSearch() {
            isSearching = false;
            clearInterval(pollingInterval);
            toggleSearchUI(false);
            fetch('/api/cancel-search', { method: 'POST' });

            // Recarrega créditos e leads após busca
            loadUserInfo();
            loadLeadsFromDB();
        }

        function updateProgress(data) {
            const pct = Math.round((data.processados / (data.total || 1)) * 100);
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('currentBusiness').innerText = data.current || 'Processando...';
            document.getElementById('leadsFoundCount').innerText = data.leads_found || 0;
        }

        function filterLeads(status) {
            currentStatusFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.dataset.status === status;
                btn.className = isActive ? 'filter-btn bg-white text-gray-900 px-4 py-3 rounded-full text-sm font-bold shadow-lg transition' : 'filter-btn bg-gray-800 border border-gray-700 text-gray-300 px-4 py-3 rounded-full text-sm font-medium hover:bg-gray-700 transition';
            });
            applyFilters();
        }

        function applyFilters() { renderLeads(); }

        function renderLeads() {
            const grid = document.getElementById('leadsGrid');
            grid.innerHTML = '';
            const cityFilter = document.getElementById('filterCity').value.toLowerCase();
            const nicheFilter = document.getElementById('filterNiche').value.toLowerCase();

            const filtered = leads.filter(l => {
                if (currentStatusFilter !== 'all' && (l.status || 'new') !== currentStatusFilter) return false;
                if (cityFilter && !(l.cidade || '').toLowerCase().includes(cityFilter) && !(l.endereco || '').toLowerCase().includes(cityFilter)) return false;
                if (nicheFilter && !(l.nicho || '').toLowerCase().includes(nicheFilter)) return false;
                return true;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-10 text-center text-gray-500">Nenhum lead nos filtros atuais</div>`;
                return;
            }

            filtered.slice().reverse().forEach(l => {
                const card = document.createElement('div');
                card.className = "bg-gray-900 border border-gray-800 rounded-2xl p-5 shadow-lg card-hover relative flex flex-col h-full transition-all";

                // Cores de status
                if (l.status === 'contacted') card.classList.add('border-green-800/50');
                if (l.status === 'interested') card.classList.add('border-blue-800/50', 'bg-blue-900/5');
                if (l.status === 'discarded') card.classList.add('opacity-40', 'grayscale');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-1 bg-yellow-500/10 px-2 py-1 rounded-lg">
                            <i class="fas fa-star text-yellow-500 text-xs"></i>
                            <span class="text-xs font-bold text-yellow-500">${l.avaliacao || '0.0'}</span>
                        </div>
                        <span class="text-[10px] text-gray-400 font-bold uppercase truncate max-w-[100px]">${l.cidade || ''}</span>
                    </div>
                    <div class="mb-auto">
                        <h3 class="font-bold text-lg text-white mb-1 line-clamp-1">${l.nome}</h3>
                        <p class="text-xs text-gray-400 flex items-start gap-2 mb-4">
                            <i class="fas fa-location-dot mt-0.5"></i> <span class="line-clamp-2">${l.endereco || ''}</span>
                        </p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-gray-950 p-2 rounded-lg text-center border border-gray-800">
                            <p class="text-[10px] text-gray-500 uppercase font-bold">Tel</p>
                            <p class="text-xs font-mono text-gray-300 truncate">${l.telefone || '--'}</p>
                        </div>
                        <div class="bg-gray-950 p-2 rounded-lg text-center border border-gray-800 cursor-pointer" onclick="window.open('${l.google_maps_link}', '_blank')">
                            <p class="text-[10px] text-gray-500 uppercase font-bold">Maps</p>
                            <p class="text-xs text-blue-400 font-bold">Ver <i class="fas fa-external-link-alt"></i></p>
                        </div>
                    </div>
                    <div class="flex gap-2 border-t border-gray-800 pt-3">
                        <button onclick="sendWhatsapp('${l.whatsapp}', '${l.nome}', '${l.cidade}', '${l.nicho}', this)" 
                            class="flex-1 ${l.whatsapp ? 'bg-green-600 hover:bg-green-500' : 'bg-gray-700'} text-white font-bold py-2 rounded-xl text-sm flex items-center justify-center gap-2 transition">
                            <i class="fab fa-whatsapp"></i> <span>${l.status === 'contacted' ? 'Enviado' : 'Abordar'}</span>
                        </button>
                        
                        <div class="relative group">
                            <button class="w-10 h-10 bg-gray-800 rounded-xl flex items-center justify-center text-gray-400 hover:text-white transition">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-40 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl hidden group-hover:block p-1 z-50">
                                <button onclick="changeStatus('${l.nome}', 'interested')" class="w-full text-left px-3 py-2 text-xs text-blue-400 hover:bg-gray-700 rounded flex items-center gap-2">
                                    <i class="fas fa-heart"></i> Interessado
                                </button>
                                <button onclick="changeStatus('${l.nome}', 'new')" class="w-full text-left px-3 py-2 text-xs text-gray-400 hover:bg-gray-700 rounded flex items-center gap-2">
                                    <i class="fas fa-undo"></i> Resetar
                                </button>
                                <button onclick="changeStatus('${l.nome}', 'discarded')" class="w-full text-left px-3 py-2 text-xs text-red-500 hover:bg-gray-700 rounded flex items-center gap-2">
                                    <i class="fas fa-times-circle"></i> Descartar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            document.getElementById('countAll').innerText = leads.length;
        }

        function sendWhatsapp(phone, name, city, niche, btn) {
            if (!phone) return alert('Telefone não disponível');
            const msg = (localStorage.getItem('leadManager_msg') || msgTemplate)
                .replace(/{nome}/g, name).replace(/{nicho}/g, niche).replace(/{cidade}/g, city);
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            const lead = leads.find(l => l.nome === name);
            if (lead) { lead.status = 'contacted'; renderLeads(); }
        }

        function changeStatus(name, status) {
            const lead = leads.find(l => l.nome === name);
            if (lead) {
                lead.status = status;
                renderLeads();
            }
        }

        function openScriptModal() { document.getElementById('scriptModal').classList.remove('hidden'); }
        function closeScriptModal() { document.getElementById('scriptModal').classList.add('hidden'); }
        function saveScript() { localStorage.setItem('leadManager_msg', document.getElementById('msgTemplate').value); closeScriptModal(); }
        function resetScript() { document.getElementById('msgTemplate').value = "Olá! Encontrei a *{nome}* no Google Maps aqui de {cidade}..."; }
        function logout() { fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/login'); }
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(leads);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Leads");
            XLSX.writeFile(wb, "prospects.xlsx");
        }
    </script>
</body>

</html>