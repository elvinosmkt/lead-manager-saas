<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Lead Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-950 text-white min-h-screen pb-20">

    <!-- Navbar Fixa -->
    <nav class="border-b border-gray-800 bg-gray-900/90 backdrop-blur sticky top-0 z-40 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div
                        class="w-9 h-9 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/50">
                        <i class="fas fa-rocket text-white text-sm"></i>
                    </div>
                    <div>
                        <span class="font-bold text-lg tracking-tight">LeadManager</span>
                        <span class="text-[10px] uppercase font-bold text-gray-400 block -mt-1 tracking-widest">CRM &
                            Scraper</span>
                    </div>
                </div>

                <!-- Status Bar -->
                <div class="flex items-center gap-6">
                    <!-- Configurar Mensagem -->
                    <button onclick="openScriptModal()"
                        class="hidden md:flex items-center gap-2 text-sm text-gray-300 hover:text-white bg-gray-800/50 hover:bg-gray-800 px-3 py-1.5 rounded-full border border-gray-700 transition">
                        <i class="fas fa-comment-dots text-green-400"></i>
                        <span>Script de Venda</span>
                    </button>

                    <!-- Saldo -->
                    <div class="bg-gray-800 rounded-full px-4 py-1.5 border border-gray-700 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-xs text-gray-400 uppercase font-bold">Cr√©ditos</span>
                        <span id="creditsDisplay" class="font-mono font-bold text-green-400">---</span>
                    </div>

                    <!-- User -->
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block">
                            <h4 id="userName" class="text-sm font-bold leading-none">Admin</h4>
                            <span class="text-xs text-blue-400">Plano Pro</span>
                        </div>
                        <div class="w-9 h-9 rounded-full bg-gradient-to-r from-gray-700 to-gray-600 border-2 border-gray-800 shadow-xl overflow-hidden cursor-pointer"
                            onclick="logout()">
                            <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="User">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 mt-8">

        <!-- √Årea de Busca (Compacta) -->
        <div
            class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-2xl p-1 shadow-2xl border border-gray-800 mb-10 overflow-hidden relative group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <i class="fas fa-search text-6xl"></i>
            </div>

            <div class="bg-gray-900/90 p-6 rounded-xl backdrop-blur-sm">
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Nicho</label>
                        <div class="relative">
                            <i class="fas fa-tag absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="text" id="nichoInput" placeholder="Ex: Pizzaria, Dentista..."
                                class="w-full bg-gray-950 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition shadow-inner">
                        </div>
                    </div>

                    <div class="flex-1 w-full space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Cidade</label>
                        <div class="relative">
                            <i class="fas fa-location-dot absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="text" id="cidadeInput" placeholder="Ex: Centro, S√£o Paulo..."
                                class="w-full bg-gray-950 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition shadow-inner">
                        </div>
                    </div>

                    <div class="w-32 space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Qtd</label>
                        <select id="maxLeadsInput"
                            class="w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-3 text-white outline-none">
                            <option value="10">10 Leads</option>
                            <option value="50">50 Leads</option>
                            <option value="100">100 Leads</option>
                        </select>
                    </div>

                    <div class="w-40 space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Site</label>
                        <select id="filterSiteInput"
                            class="w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-3 text-white outline-none">
                            <option value="todos">üåê Todos</option>
                            <option value="sem-site">üö´ Sem Site</option>
                            <option value="com-site">‚úÖ Com Site</option>
                        </select>
                    </div>

                    <div class="w-44 space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">WhatsApp</label>
                        <select id="filterWhatsInput"
                            class="w-full bg-gray-950 border border-gray-700 rounded-xl px-3 py-3 text-white outline-none">
                            <option value="todos">üì± Todos</option>
                            <option value="com-whats">‚úÖ Com WhatsApp</option>
                            <option value="sem-whats">üö´ Sem WhatsApp</option>
                        </select>
                    </div>

                    <button id="btnSearch" onclick="startSearch()"
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-900/30 transition transform active:scale-95 flex items-center justify-center gap-2 border border-blue-500/50">
                        <i class="fas fa-search"></i>
                        <span>BUSCAR</span>
                    </button>

                    <button id="btnStop" onclick="stopSearch()"
                        class="hidden w-full md:w-auto bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-red-900/30 transition transform active:scale-95 flex items-center justify-center gap-2 border border-red-500/50">
                        <i class="fas fa-stop"></i>
                        <span>PARAR</span>
                    </button>
                </div>

                <!-- Barra de Progresso Integrada -->
                <div id="progressContainer"
                    class="hidden mt-6 bg-gray-800 rounded-lg p-3 flex items-center gap-4 border border-gray-700">
                    <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin text-blue-400"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-blue-300 font-bold" id="currentBusiness">Iniciando motor de
                                busca...</span>
                            <span class="text-gray-400 font-mono"><span id="leadsFoundCount">0</span> leads</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                            <div id="progressBar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros de Funil e Busca Avan√ßada -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <!-- Filtros de Status (Abas) -->
            <div class="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide flex-1">
                <button onclick="filterLeads('all')"
                    class="filter-btn active bg-white text-gray-900 px-4 py-3 rounded-full text-sm font-bold shadow-lg transition"
                    data-status="all">
                    Todos <span id="countAll"
                        class="bg-gray-200 text-gray-800 px-1.5 py-0.5 rounded-full text-[10px] ml-1">0</span>
                </button>
                <button onclick="filterLeads('contacted')"
                    class="filter-btn bg-gray-800 border border-gray-700 text-green-400 px-4 py-3 rounded-full text-sm font-medium hover:bg-gray-700 transition"
                    data-status="contacted">
                    Contactados
                </button>
            </div>

            <!-- Filtros de Texto (Cidade/Area) -->
            <div class="flex gap-2">
                <div class="relative flex-1 md:flex-none">
                    <i class="fas fa-map-marker-alt absolute left-3 top-3 text-gray-500 text-xs"></i>
                    <input type="text" id="filterCity" list="citiesList" oninput="applyFilters()"
                        placeholder="Filtrar Cidade"
                        class="bg-gray-900 border border-gray-700 rounded-xl pl-8 pr-3 py-2.5 text-sm text-white focus:border-blue-500 outline-none w-full md:w-44 transition shadow-inner">
                    <datalist id="citiesList"></datalist>
                </div>
                <div class="relative flex-1 md:flex-none">
                    <i class="fas fa-briefcase absolute left-3 top-3 text-gray-500 text-xs"></i>
                    <input type="text" id="filterNiche" list="nichesList" oninput="applyFilters()"
                        placeholder="Filtrar Nicho"
                        class="bg-gray-900 border border-gray-700 rounded-xl pl-8 pr-3 py-2.5 text-sm text-white focus:border-blue-500 outline-none w-full md:w-44 transition shadow-inner">
                    <datalist id="nichesList"></datalist>
                </div>
            </div>

            <button onclick="exportToExcel()"
                class="bg-gray-800 hover:bg-gray-700 text-gray-100 border border-gray-600 rounded-xl px-4 py-2 text-sm font-medium transition flex items-center gap-2">
                <i class="fas fa-download"></i> Exportar
            </button>
        </div>

        <!-- Grid de Cards (CRM) -->
        <div id="leadsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Empty State -->
            <div id="emptyState"
                class="col-span-full py-20 text-center border-2 border-dashed border-gray-800 rounded-3xl bg-gray-900/30">
                <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-ghost text-3xl text-gray-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-300">Nenhum lead por aqui</h3>
                <p class="text-gray-500 mt-2 max-w-sm mx-auto">Fa√ßa uma busca acima para encontrar empresas sem site e
                    come√ßar a vender.</p>
            </div>
        </div>

    </main>

    <!-- Modal: Script de Venda -->
    <div id="scriptModal"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div
            class="bg-gray-900 border border-gray-800 rounded-2xl w-full max-w-lg shadow-2xl transform transition-all p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fab fa-whatsapp text-green-500"></i> Configurar Abordagem
                </h3>
                <button onclick="closeScriptModal()" class="text-gray-500 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="space-y-4">
                <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-lg text-sm text-blue-200">
                    <p class="font-bold mb-1"><i class="fas fa-info-circle"></i> Vari√°veis:</p>
                    <code class="bg-black/30 px-1 rounded text-blue-300">{nome}</code>, <code
                        class="bg-black/30 px-1 rounded text-blue-300">{nicho}</code>, <code
                        class="bg-black/30 px-1 rounded text-blue-300">{cidade}</code>
                </div>

                <textarea id="msgTemplate" rows="6"
                    class="w-full bg-gray-950 border border-gray-700 rounded-xl p-4 text-gray-300 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none resize-none"
                    placeholder="Ol√°, vi a {nome} no Google..."></textarea>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="resetScript()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">Padr√£o</button>
                <button onclick="saveScript()"
                    class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-green-900/30 transition">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>

    <!-- Scripts -->
    <script>
        // URL da API (Railway Production)
        const API_URL = 'https://web-production-a818.up.railway.app/api';

        let leads = [];
        let isSearching = false;
        let pollingInterval = null;
        let currentStatusFilter = 'all';
        let msgTemplate;
        try {
            msgTemplate = localStorage.getItem('leadManager_msg') ||
                "Ol√°! Encontrei a *{nome}* no Google Maps aqui de {cidade} e vi que a empresa ainda n√£o tem um Site Profissional.\n\nSou especialista em criar sites para {nicho} que atraem mais clientes. Gostaria de ver uma proposta?";
        } catch (e) {
            console.error("Erro ao ler msg salva:", e);
            localStorage.removeItem('leadManager_msg');
            msgTemplate = "Ol√°! Encontrei a *{nome}* no Google Maps...";
        }

        /*
        async function loadUserInfo() {
             // Rota n√£o implementada no backend, dados vem do Supabase
        }
        */

        // ID da sess√£o ser√° o user ID real
        let sessionId = null;

        async function startSearch() {
            const user = await LeadAPI.getUser();
            if (!user) return alert('Fa√ßa login primeiro!');

            const realUserId = user.id; // UUID do Supabase
            // Atualiza sessionID global para polling usar o ID Certo
            sessionId = realUserId;

            const nicho = document.getElementById('nichoInput').value;
            const cidade = document.getElementById('cidadeInput').value;
            if (!nicho || !cidade) return alert('Preencha os campos!');

            toggleSearchUI(true);
            leads = [];
            renderLeads(); // Limpa tela para nova busca

            try {
                const res = await fetch(`${API_URL}/start-search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nicho,
                        cidade,
                        max_leads: document.getElementById('maxLeadsInput').value,
                        user_id: realUserId, // Envia ID real para salvar no banco
                        filter_site: document.getElementById('filterSiteInput')?.value || 'todos', // Suporte futuro
                        filter_whats: document.getElementById('filterWhatsInput')?.value || 'todos'
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    if (data.status === 'queued') {
                        showNotification('‚è≥ Voc√™ est√° na fila de espera...', 'info');
                    }
                    startPolling();
                } else {
                    if (data.error && data.error.includes('andamento') && data.session_id !== sessionId) {
                        // Erro global antigo, n√£o deve acontecer com novo backend, mas por seguran√ßa:
                        alert('Servidor ocupado. Tente novamente em alguns segundos.');
                    } else {
                        throw new Error(data.error || 'Erro ao iniciar');
                    }
                }
            } catch (error) {
                console.error(error);
                alert('Erro: ' + error.message);
                toggleSearchUI(false);
            }
        }

        function toggleSearchUI(searching) {
            isSearching = searching;
            document.getElementById('btnSearch').classList.toggle('hidden', searching);
            document.getElementById('btnStop').classList.toggle('hidden', !searching);
            document.getElementById('progressContainer').classList.toggle('hidden', !searching);

            // Texto de status
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.innerText = searching ? 'Iniciando...' : '';
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);

            pollingInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_URL}/search-status?session_id=${sessionId}`);
                    const data = await res.json();

                    // Atualiza UI baseada no status da fila
                    const statusText = document.getElementById('statusText'); // Assumindo que existe ou criar
                    if (data.status === 'queued') {
                        if (statusText) statusText.innerText = '‚è≥ Aguardando vaga na fila...';
                        return; // N√£o atualiza barra de progresso ainda
                    } else if (data.status === 'initializing') {
                        if (statusText) statusText.innerText = 'üöÄ Preparando rob√¥...';
                    } else if (data.status === 'running') {
                        if (statusText) statusText.innerText = `üîç Buscando: ${data.current || '...'}`;
                    }

                    updateProgress(data);

                    if (data.leads && data.leads.length > leads.length) {
                        leads = data.leads.map(l => ({ ...l, status: l.status || 'new' }));
                        renderLeads();
                    }

                    if (!data.running && data.completed) {
                        stopSearch();
                        showNotification('‚úÖ Busca finalizada!');
                    }
                    if (data.status === 'error') {
                        stopSearch();
                        alert('Erro na busca: ' + data.error);
                    }
                } catch (e) {
                    console.error("Erro no polling:", e);
                }
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Verifica API Status
            // Verifica login com prote√ß√£o contra Tokens Corrompidos
            let user = null;
            try {
                user = await LeadAPI.getUser();
            } catch (e) {
                console.error("Erro cr√≠tico ao recuperar usu√°rio (Token inv√°lido?):", e);
                // Se der erro de padr√£o de string (atob) ou outro, limpa tudo e reloga
                localStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            sessionId = user.id; // Garante polling correto

            // Carrega info do usu√°rio
            const emailUser = user.email || 'Admin';
            document.getElementById('userName').innerText = emailUser.split('@')[0];
            document.getElementById('creditsDisplay').innerText = "PRO"; // Valor fixo por enqt

            // Carrega leads salvos do Supabase
            console.log('üîÑ Carregando hist√≥rico de leads...');
            leads = await LeadAPI.getAll();
            console.log(`‚úÖ ${leads.length} leads carregados do banco.`);

            // Atualiza UI
            renderLeads();
            updateStats();

            // Configura template padr√£o se n√£o existir
            if (!localStorage.getItem('leadManager_msg')) {
                localStorage.setItem('leadManager_msg', msgTemplate);
            }
            document.getElementById('msgTemplate').value = localStorage.getItem('leadManager_msg');
        });

        // --- L√ìGICA DE POLLING MELHORADA ---
        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);

            pollingInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_URL}/search-status?session_id=${sessionId}`);
                    const data = await res.json();

                    const statusText = document.getElementById('statusText');

                    if (data.status === 'queued') {
                        if (statusText) statusText.innerText = '‚è≥ Na fila (posi√ß√£o ' + (data.position || '?') + ')...';
                        return;
                    }

                    if (data.status === 'running') {
                        if (statusText) statusText.innerText = `üîç Buscando: ${data.current || '...'}`;
                        updateProgress(data);
                    }

                    // ATUALIZA√á√ÉO EM TEMPO REAL (STREAMING)
                    if (data.leads && data.leads.length > 0) {
                        // Mescla leads novos com existentes
                        let mudou = false;
                        data.leads.forEach(newLead => {
                            // Verifica duplicidade pelo nome/telefone ou ID se tiver
                            const exists = leads.some(l =>
                                (l.nome === newLead.nome && l.endereco === newLead.endereco) ||
                                (l.telefone && l.telefone === newLead.telefone)
                            );

                            if (!exists) {
                                leads.unshift({ ...newLead, status: 'new' }); // Adiciona no topo
                                mudou = true;
                            }
                        });

                        if (mudou) {
                            renderLeads();
                            updateStats();
                        }
                    }

                    if (data.completed) {
                        stopSearch();
                        showNotification(`‚úÖ Busca finalizada! ${data.leads_found} encontrados.`);
                        // Recarrega do banco para garantir integridade e IDs
                        setTimeout(async () => {
                            leads = await LeadAPI.getAll();
                            renderLeads();
                        }, 1000);
                    }

                    if (data.status === 'error') {
                        stopSearch();
                        alert('Erro na busca: ' + data.error);
                    }
                } catch (e) {
                    console.error("Erro no polling:", e);
                }
            }, 1000); // Polling a cada 1s para ser r√°pido
        }

        function updateProgress(data) {
            const pct = Math.round((data.processados / (data.total || 1)) * 100);
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('currentBusiness').innerText = data.current || 'Processando...';
            document.getElementById('leadsFoundCount').innerText = data.leads_found || 0;
        }

        function filterLeads(status) {
            currentStatusFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.dataset.status === status;
                btn.className = isActive ? 'filter-btn bg-white text-gray-900 px-4 py-3 rounded-full text-sm font-bold shadow-lg transition' : 'filter-btn bg-gray-800 border border-gray-700 text-gray-300 px-4 py-3 rounded-full text-sm font-medium hover:bg-gray-700 transition';
            });
            applyFilters();
        }

        function applyFilters() { renderLeads(); }

        function renderLeads() {
            const grid = document.getElementById('leadsGrid');
            grid.innerHTML = '';
            const cityFilter = document.getElementById('filterCity').value.toLowerCase();
            const nicheFilter = document.getElementById('filterNiche').value.toLowerCase();

            const filtered = leads.filter(l => {
                if (currentStatusFilter !== 'all' && (l.status || 'new') !== currentStatusFilter) return false;
                if (cityFilter && !(l.cidade || '').toLowerCase().includes(cityFilter) && !(l.endereco || '').toLowerCase().includes(cityFilter)) return false;
                if (nicheFilter && !(l.nicho || '').toLowerCase().includes(nicheFilter)) return false;
                return true;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-10 text-center text-gray-500">Nenhum lead nos filtros atuais</div>`;
                return;
            }

            filtered.slice().reverse().forEach(l => {
                const card = document.createElement('div');
                card.className = "bg-gray-900 border border-gray-800 rounded-2xl p-5 shadow-lg card-hover relative flex flex-col h-full transition-all";

                // Cores de status
                if (l.status === 'contacted') card.classList.add('border-green-800/50');
                if (l.status === 'interested') card.classList.add('border-blue-800/50', 'bg-blue-900/5');
                if (l.status === 'discarded') card.classList.add('opacity-40', 'grayscale');

                // Verifica Site e Whats para Badges
                const hasSite = l.site && l.site.length > 5;
                const hasWhats = l.whatsapp && l.whatsapp.length > 5;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex gap-2">
                             ${!hasSite ?
                        `<span class="bg-red-500/20 text-red-400 text-[10px] font-bold px-2 py-0.5 rounded border border-red-500/30 flex items-center gap-1"><i class="fas fa-globe"></i> SEM SITE</span>` :
                        `<span class="bg-blue-500/20 text-blue-400 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-500/30 flex items-center gap-1"><i class="fas fa-check"></i> COM SITE</span>`
                    }
                             ${hasWhats ?
                        `<span class="bg-green-500/20 text-green-400 text-[10px] font-bold px-2 py-0.5 rounded border border-green-500/30 flex items-center gap-1"><i class="fab fa-whatsapp"></i> ZAP</span>` : ''
                    }
                        </div>
                        <div class="flex items-center gap-1 bg-yellow-500/10 px-2 py-1 rounded-lg">
                            <i class="fas fa-star text-yellow-500 text-xs"></i>
                            <span class="text-xs font-bold text-yellow-500">${l.avaliacao || '0.0'}</span>
                        </div>
                    </div>

                    <div class="mb-auto">
                        <h3 class="font-bold text-lg text-white mb-1 line-clamp-1" title="${l.nome}">${l.nome}</h3>
                        <p class="text-xs text-gray-500 font-bold uppercase mb-1 tracking-wider">${l.nicho || 'Geral'}</p>
                        <p class="text-xs text-gray-400 flex items-start gap-2 mb-4">
                            <i class="fas fa-map-pin mt-0.5 text-gray-600"></i> <span class="line-clamp-2">${l.endereco || 'Endere√ßo n√£o detectado'}</span>
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-gray-950 p-2 rounded-lg text-center border border-gray-800">
                            <p class="text-[10px] text-gray-500 uppercase font-bold">Telefone</p>
                            <p class="text-xs font-mono text-gray-300 truncate select-all">${l.telefone || '--'}</p>
                        </div>
                        <a href="${l.google_maps_link}" target="_blank" class="bg-blue-600/10 hover:bg-blue-600/20 border border-blue-600/30 p-2 rounded-lg text-center cursor-pointer transition flex flex-col items-center justify-center group">
                            <p class="text-[10px] text-blue-400 uppercase font-bold group-hover:text-blue-300">Google Maps</p>
                            <span class="text-xs text-blue-500 font-bold group-hover:text-blue-200"><i class="fas fa-external-link-alt"></i> Abrir</span>
                        </a>
                    </div>

                    <div class="flex gap-2 border-t border-gray-800 pt-3">
                        <button onclick="sendWhatsapp('${l.whatsapp}', '${l.nome}', '${l.cidade}', '${l.nicho}', this)" 
                            class="flex-1 ${hasWhats ? 'bg-green-600 hover:bg-green-500' : 'bg-gray-700 opacity-50 cursor-not-allowed'} text-white font-bold py-2 rounded-xl text-sm flex items-center justify-center gap-2 transition">
                            <i class="fab fa-whatsapp"></i> <span>${l.status === 'contacted' ? 'Enviado' : 'Abordar'}</span>
                        </button>
                        
                        <div class="relative group">
                            <button class="w-10 h-10 bg-gray-800 rounded-xl flex items-center justify-center text-gray-400 hover:text-white transition">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-40 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl hidden group-hover:block p-1 z-50">
                                <button onclick="changeStatus('${l.nome}', 'interested')" class="w-full text-left px-3 py-2 text-xs text-blue-400 hover:bg-gray-700 rounded flex items-center gap-2">
                                    <i class="fas fa-heart"></i> Interessado
                                </button>
                                <button onclick="changeStatus('${l.nome}', 'new')" class="w-full text-left px-3 py-2 text-xs text-gray-400 hover:bg-gray-700 rounded flex items-center gap-2">
                                    <i class="fas fa-undo"></i> Resetar
                                </button>
                                <button onclick="changeStatus('${l.nome}', 'discarded')" class="w-full text-left px-3 py-2 text-xs text-red-500 hover:bg-gray-700 rounded flex items-center gap-2">
                                    <i class="fas fa-times-circle"></i> Descartar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            document.getElementById('countAll').innerText = leads.length;
        }

        // --- Perfil User ---
        async function openProfileModal() {
            const user = await LeadAPI.getUser();
            if (!user) return;

            // Cria modal din√¢micamente se n√£o existir
            if (!document.getElementById('profileModal')) {
                const modal = document.createElement('div');
                modal.id = 'profileModal';
                modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden';
                modal.innerHTML = `
                    <div class="bg-gray-900 border border-gray-800 rounded-2xl w-full max-w-sm shadow-2xl p-6 relative">
                        <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full mx-auto flex items-center justify-center text-3xl font-bold mb-3">
                                ${user.email[0].toUpperCase()}
                            </div>
                            <h3 class="text-xl font-bold text-white">${user.email.split('@')[0]}</h3>
                            <p class="text-sm text-gray-500">${user.email}</p>
                        </div>
                        <div class="space-y-3">
                            <div class="bg-gray-950 p-3 rounded-lg border border-gray-800 flex justify-between">
                                <span class="text-gray-400 text-sm">Plano</span>
                                <span class="text-green-400 text-sm font-bold">PRO (Beta)</span>
                            </div>
                            <div class="bg-gray-950 p-3 rounded-lg border border-gray-800 flex justify-between">
                                <span class="text-gray-400 text-sm">ID</span>
                                <span class="text-gray-600 text-xs font-mono">${user.id.substr(0, 8)}...</span>
                            </div>
                        </div>
                        <button onclick="logout()" class="w-full mt-6 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 font-bold py-2 rounded-xl transition">
                            Sair do Sistema
                        </button>
                    </div>
                 `;
                document.body.appendChild(modal);
            }
            document.getElementById('profileModal').classList.remove('hidden');
        }
        function sendWhatsapp(phone, name, city, niche, btn) {
            if (!phone) return alert('Telefone n√£o dispon√≠vel');
            const msg = (localStorage.getItem('leadManager_msg') || msgTemplate)
                .replace(/{nome}/g, name).replace(/{nicho}/g, niche).replace(/{cidade}/g, city);
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            const lead = leads.find(l => l.nome === name);
            if (lead) {
                lead.status = 'contacted';
                renderLeads();
                // Salvar status contatado
                LeadAPI.save(lead).catch(console.error);
            }
        }

        function updateStats() {
            // Conta leads por status
            const total = leads.length;
            const novos = leads.filter(l => !l.status || l.status === 'new').length;
            const contatados = leads.filter(l => l.status === 'contacted').length;
            const interessados = leads.filter(l => l.status === 'interested').length;

            document.getElementById('countAll').innerText = total;
            // Se tiver elementos para os outros contadores, atualize-os aqui
            // Ex: document.getElementById('countNew').innerText = novos;

            if (document.getElementById('emptyState')) {
                document.getElementById('emptyState').style.display = total === 0 ? 'block' : 'none';
            }

            // Atualiza op√ß√µes de filtro din√¢micas
            updateFilterOptions();
        }

        function updateFilterOptions() {
            // Extrai cidades e nichos √∫nicos
            const cities = [...new Set(leads.map(l => l.cidade).filter(Boolean))].sort();
            const niches = [...new Set(leads.map(l => l.nicho).filter(Boolean))].sort();

            const citiesList = document.getElementById('citiesList');
            const nichesList = document.getElementById('nichesList');

            // S√≥ atualiza se o elemento n√£o estiver em foco (para n√£o atrapalhar digita√ß√£o)
            if (document.activeElement !== document.getElementById('filterCity')) {
                citiesList.innerHTML = cities.map(c => `<option value="${c}">`).join('');
            }
            if (document.activeElement !== document.getElementById('filterNiche')) {
                nichesList.innerHTML = niches.map(n => `<option value="${n}">`).join('');
            }
        }

        async function changeStatus(name, status) {
            const lead = leads.find(l => l.nome === name);
            if (lead) {
                lead.status = status;
                renderLeads();

                // Salvar no Supabase
                try {
                    // Precisamos do ID para update, se n√£o tiver ID (lead novo da mem√≥ria), buscamos pelo nome ou usamos save que trata
                    await LeadAPI.save(lead);
                } catch (e) {
                    console.error('Erro ao salvar status:', e);
                }
            }
        }

        function openScriptModal() { document.getElementById('scriptModal').classList.remove('hidden'); }
        function closeScriptModal() { document.getElementById('scriptModal').classList.add('hidden'); }
        function saveScript() { localStorage.setItem('leadManager_msg', document.getElementById('msgTemplate').value); closeScriptModal(); }
        function resetScript() { document.getElementById('msgTemplate').value = "Ol√°! Encontrei a *{nome}* no Google Maps aqui de {cidade}..."; }

        async function logout() {
            await LeadAPI.logout();
            window.location.href = 'login.html';
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') return alert('Biblioteca Excel n√£o carregada');
            const ws = XLSX.utils.json_to_sheet(leads);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Leads");
            XLSX.writeFile(wb, "prospects.xlsx");
        }
    </script>
</body>

</html>